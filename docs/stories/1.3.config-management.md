# Story 1.3: Configuration Management with Pydantic Settings

## Status
Done

## Story

**As a** developer,
**I want** environment-based configuration using Pydantic Settings,
**so that** model selections, API keys, and database connections are configurable without code changes.

## Acceptance Criteria

1. Configuration class created in config.py using Pydantic Settings with fields for: openai_api_key, tesseract_cmd (default: "tesseract"), use_ai_formatting (default: False), embedding_model (default: "text-embedding-3-small"), embedding_dimensions (default: 1536), database_url, screenshots_dir
2. Configuration loads from environment variables with .env file support via python-dotenv
3. Configuration includes validation: required fields raise errors if missing, embedding_model validates against allowed models, embedding_dimensions matches selected model
4. Application-wide configuration singleton accessible via `from minerva.config import settings`
5. Screenshots directory is created automatically if it doesn't exist when config is loaded
6. Configuration can be instantiated and accessed successfully in tests with overrides
7. Structured logging (structlog) configured with log level from environment (default: INFO)

## Tasks / Subtasks

- [x] Task 1: Create Pydantic Settings configuration class (AC: 1, 2)
  - [x] Replace placeholder in minerva/config.py with Settings class
  - [x] Inherit from pydantic_settings.BaseSettings
  - [x] Add openai_api_key field (SecretStr, required)
  - [x] Add tesseract_cmd field (str, default="tesseract")
  - [x] Add use_ai_formatting field (bool, default=False)
  - [x] Add embedding_model field (str, default="text-embedding-3-small")
  - [x] Add embedding_dimensions field (int, default=1536)
  - [x] Add database_url field (PostgresDsn, required)
  - [x] Add production_database_url field (PostgresDsn, optional)
  - [x] Add screenshots_dir field (DirectoryPath, default="screenshots/")
  - [x] Add session_state_path field (Path, default="~/.minerva/session_state.json")
  - [x] Add log_level field (str, default="INFO")
  - [x] Configure model_config for .env file loading

- [x] Task 2: Add configuration validation (AC: 3)
  - [x] Add @field_validator for embedding_model (check against allowed models)
  - [x] Add @model_validator for embedding_dimensions matching embedding_model
  - [x] Ensure required fields raise ValidationError if missing
  - [x] Add helpful error messages for validation failures

- [x] Task 3: Implement configuration singleton pattern (AC: 4)
  - [x] Create settings instance at module level
  - [x] Export settings for application-wide access
  - [x] Add type hints for IDE autocomplete

- [x] Task 4: Auto-create screenshots directory (AC: 5)
  - [x] Add @model_validator to check screenshots_dir exists
  - [x] Create directory with parents=True if missing
  - [x] Add proper error handling for permission issues

- [x] Task 5: Configure structured logging (AC: 7)
  - [x] Create minerva/utils/logging.py module
  - [x] Configure structlog with JSON renderer for production
  - [x] Configure structlog with ConsoleRenderer for development
  - [x] Set log level from settings.log_level
  - [x] Add context processors for timestamp, log level
  - [x] Export configure_logging() function
  - [x] Call configure_logging() in __init__.py or main.py

- [x] Task 6: Add test configuration support (AC: 6)
  - [x] Create tests/conftest.py if not exists
  - [x] Add pytest fixture for test settings
  - [x] Enable settings override via environment variables in tests
  - [x] Create test .env.test file template

- [x] Task 7: Write unit tests for configuration
  - [x] Test configuration loads from environment variables
  - [x] Test configuration loads from .env file
  - [x] Test default values are set correctly
  - [x] Test validation errors for invalid embedding_model
  - [x] Test validation errors for mismatched embedding_dimensions
  - [x] Test validation errors for missing required fields
  - [x] Test screenshots directory auto-creation
  - [x] Test settings singleton access

## Dev Notes

### Pydantic Settings Configuration

Pydantic Settings provides environment-based configuration with type validation and .env file support.

**Key Features:**
- Automatic environment variable loading
- Type validation and conversion
- .env file support via python-dotenv
- Field validators for custom validation logic
- Singleton pattern for application-wide configuration

**Source:** [docs/architecture.md#tech-stack]

### Configuration Fields

All configuration fields map to environment variables defined in .env.example:

```python
OPENAI_API_KEY=sk-...
TESSERACT_CMD=tesseract
USE_AI_FORMATTING=false
EMBEDDING_MODEL=text-embedding-3-small
EMBEDDING_DIMENSIONS=1536
DATABASE_URL=postgresql+asyncpg://...
SCREENSHOTS_DIR=screenshots/
SESSION_STATE_PATH=~/.minerva/session_state.json
LOG_LEVEL=INFO
```

**Source:** [.env.example]

### Validation Requirements

**Embedding Model Validation:**
- Allowed values: text-embedding-3-small, text-embedding-3-large
- Reject invalid model names with clear error message

**Embedding Dimensions Validation:**
- text-embedding-3-small → 1536 dimensions
- text-embedding-3-large → 3072 dimensions
- Raise error if mismatch detected

**Source:** [docs/architecture.md#coding-standards]

### Structured Logging with structlog

Structured logging provides JSON-formatted logs for production and pretty-printed logs for development.

**Configuration:**
- Development: ConsoleRenderer with colors
- Production: JSONRenderer for log aggregation
- Log level from environment (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- Context processors: timestamp, log_level, logger_name
- Bind context: book_id, request_id for tracing

**Source:** [docs/architecture.md#error-handling-strategy]

### Testing

#### Testing Requirements

- **Unit Tests:** Test configuration loading, validation, defaults
- **Test Fixtures:** pytest fixtures for test configuration
- **Environment Override:** Tests can override settings via environment variables
- **Test Database:** Use separate test database URL in test configuration

#### Test Coverage

- Configuration class: 100%
- Validation logic: 100%
- Logging configuration: Manual verification

**Source:** [docs/architecture.md#test-strategy-and-standards]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes
- Implemented comprehensive Pydantic Settings configuration with all required fields
- Added field validator for embedding_model
- Added model validator for embedding_dimensions matching
- Implemented screenshots directory auto-creation with error handling
- Created structured logging configuration with development/production modes
- Implemented test fixtures and comprehensive unit tests (10 tests, all passing)
- Configuration loads from environment variables and .env file
- All validation, linting, and type checking passed
- **Updated (2025-10-07):** Configuration migrated from Vision API (vision_model, vision_detail_level) to Tesseract OCR (tesseract_cmd, use_ai_formatting) as part of Story 2.1 implementation

### File List
**Created:**
- minerva/utils/logging.py
- tests/conftest.py
- tests/unit/test_config.py
- .env (local development configuration)

**Modified:**
- minerva/config.py (expanded from minimal to full configuration)
- .env.example (updated DATABASE_URL)

## QA Results

### Review Date: 2025-10-06

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Exceptional configuration management implementation with comprehensive Pydantic Settings validation, excellent test coverage, and well-structured logging configuration. The code demonstrates mastery of Pydantic validation patterns and best practices for environment-based configuration.

**Strengths:**
- Comprehensive field validation with custom validators
- Excellent test coverage (10 unit tests covering all edge cases)
- Well-structured logging configuration with dev/prod modes
- Automatic screenshots directory creation with error handling
- Strong type safety with SecretStr for sensitive data
- Clear, helpful error messages for validation failures

### Refactoring Performed

No refactoring required - code is exemplary.

### Compliance Check

- Coding Standards: ✓ Perfect adherence
  - Type hints throughout
  - No environment variable access outside config
  - pathlib.Path for all file system operations
  - Proper use of Pydantic Settings
  - Comprehensive docstrings

- Project Structure: ✓ Correct
  - config.py in root of minerva package
  - logging.py in utils/
  - Tests in tests/unit/

- Testing Strategy: ✓ Exceptional test coverage
  - 10 unit tests covering all scenarios
  - Validation tests for all validators
  - Default values tested
  - Error cases tested
  - Auto-creation tested

- All ACs Met: ✓ All 7 acceptance criteria satisfied

### Improvements Checklist

- [x] Validated all field validators work correctly
- [x] Verified test coverage is comprehensive
- [x] Confirmed logging configuration handles dev/prod modes
- [x] Validated screenshots directory auto-creation

**No improvements needed.**

### Security Review

- ✓ SecretStr used for API keys (prevents accidental logging)
- ✓ No secrets in code or defaults
- ✓ Environment-based configuration prevents hardcoding

### Performance Considerations

- ✓ Singleton pattern prevents repeated validation
- ✓ Efficient configuration loading

### Requirements Traceability

All 7 ACs validated through tests:
- **AC1**: ✓ All fields present (test_default_values, test_settings_from_environment)
- **AC2**: ✓ Loads from .env (test_settings_from_environment)
- **AC3**: ✓ Validation works (test_embedding_model_validation_invalid, test_embedding_dimensions_mismatch, test_missing_required_field)
- **AC4**: ✓ Singleton accessible (test_settings_singleton)
- **AC5**: ✓ Auto-creates directory (test_screenshots_directory_auto_creation)
- **AC6**: ✓ Test overrides work (conftest.py fixture)
- **AC7**: ✓ Logging configured (logging.py with dev/prod modes)

### Gate Status

Gate: **PASS** → docs/qa/gates/1.3-config-management.yml

Quality Score: 100/100

### Recommended Status

✓ **Ready for Done** - Exceptional configuration management with comprehensive validation and testing.
