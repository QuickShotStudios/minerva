# Story 1.4: Playwright POC - Kindle Authentication and Page Capture

## Status
Done

## Story

**As a** researcher,
**I want** automated Kindle Cloud Reader navigation with authentication,
**so that** I can programmatically access and capture book pages without manual intervention.

## Acceptance Criteria

1. Playwright automation module created in core/ingestion/kindle_automation.py with KindleAutomation class
2. Browser launches in headed mode (visible window) for initial authentication with configurable headless option
3. System navigates to provided Kindle URL and detects if authentication is required
4. When unauthenticated, system pauses with clear user prompt: "Please log in to Amazon in the browser window, then press Enter to continue"
5. After authentication, system waits for book reader to fully load (canvas element or book content visible)
6. System successfully captures a single high-quality screenshot (1920x1080 PNG) of the current page
7. System can programmatically turn to the next page using appropriate selectors/keyboard navigation
8. POC validates: navigate to book URL → authenticate → capture 10 consecutive pages → save screenshots to local disk with sequential naming
9. Error handling implemented for: network failures, authentication timeouts, page load failures
10. Basic human-like delays added between page turns (1-2 seconds randomized) to avoid detection

## Tasks / Subtasks

- [x] Task 1: Set up Playwright automation module (AC: 1, 2)
  - [x] Create minerva/core/ingestion/kindle_automation.py
  - [x] Create KindleAutomation class with async methods
  - [x] Add method to launch browser (headed mode default, headless configurable)
  - [x] Configure browser context with viewport size 1920x1080
  - [x] Add proper cleanup (close browser on exit)

- [x] Task 2: Implement Kindle URL navigation and auth detection (AC: 3, 4)
  - [x] Add navigate_to_book(kindle_url) async method
  - [x] Detect authentication page vs book reader page
  - [x] Pause execution with user prompt if auth required
  - [x] Wait for user to complete login and press Enter

- [x] Task 3: Implement book reader load detection (AC: 5)
  - [x] Wait for book canvas element or content to be visible
  - [x] Add timeout handling (30 seconds default)
  - [x] Verify book content is actually loaded, not just container

- [x] Task 4: Implement screenshot capture (AC: 6)
  - [x] Add capture_screenshot() async method
  - [x] Capture full page screenshot as PNG (1920x1080)
  - [x] Save to screenshots directory with sequential naming
  - [x] Return screenshot file path

- [x] Task 5: Implement page navigation (AC: 7, 10)
  - [x] Add turn_page() async method
  - [x] Try multiple navigation methods (selectors, keyboard arrow keys)
  - [x] Add randomized delay between page turns (1-2 seconds)
  - [x] Verify page actually turned before returning

- [x] Task 6: Implement error handling (AC: 9)
  - [x] Handle network failures with retry logic
  - [x] Handle authentication timeouts
  - [x] Handle page load failures
  - [x] Log all errors with context

- [x] Task 7: Create POC validation script (AC: 8)
  - [x] Create scripts/test_playwright_poc.py
  - [x] Navigate to test Kindle URL
  - [x] Authenticate (manual step)
  - [x] Capture 10 consecutive pages
  - [x] Save screenshots with sequential names
  - [x] Verify all 10 screenshots saved successfully

## Dev Notes

### Playwright Configuration

Playwright provides browser automation with Chromium. Must use async API for compatibility with FastAPI.

**Key Configuration:**
- Browser: Chromium only (lighter than full browser suite)
- Headless: False for initial auth, True for batch processing
- Viewport: 1920x1080 for high-quality screenshots
- Timeout: 30s for page loads

**Source:** [docs/architecture.md#tech-stack]

### Kindle Cloud Reader Automation

Amazon's Kindle Cloud Reader is a single-page application (SPA) that requires careful handling.

**Detection Points:**
- Auth page: Look for Amazon login form
- Book reader: Canvas element with book content
- Page navigation: Keyboard arrows or next page button

**Anti-Detection:**
- Randomized delays (1-2s) between actions
- Human-like behavior patterns
- No rapid-fire requests

**Source:** [docs/prd.md#story-1.4]

### Testing

**Manual POC Test:**
- Run scripts/test_playwright_poc.py
- Manually authenticate when prompted
- Verify 10 screenshots captured
- Inspect screenshot quality

**Source:** [docs/architecture.md#test-strategy-and-standards]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes
- Implemented complete KindleAutomation class with async/await support
- Browser launches in configurable headed/headless mode with 1920x1080 viewport
- Authentication detection checks for Amazon login form elements
- Manual authentication flow with clear user prompts
- Book reader load detection with multiple selector fallbacks
- Screenshot capture with error handling and directory auto-creation
- Page navigation using keyboard arrows with randomized 1-2s delays
- Comprehensive error handling with retry logic (3 attempts) for navigation
- All errors logged with context using Python logging
- POC validation script created and made executable
- Async context manager support for automatic cleanup
- All code passes black formatting, ruff linting, and mypy type checking

### File List
**Created:**
- minerva/core/ingestion/kindle_automation.py
- scripts/test_playwright_poc.py

**Modified:**
- None

## QA Results

### Review Date: 2025-10-06
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent Playwright automation implementation with proper async/await patterns, comprehensive error handling, and well-structured browser lifecycle management. Code demonstrates solid understanding of browser automation best practices and Python async patterns.

**Strengths:**
- Proper async context manager implementation (__aenter__/__aexit__)
- Comprehensive error handling with retry logic
- Human-like delays with randomization
- Clean separation of concerns (navigation, auth detection, screenshot capture, page turning)
- Type hints throughout with mypy compliance
- Good logging for debugging and user feedback

### Refactoring Performed

No refactoring required - code follows all standards.

### Compliance Check

- Coding Standards: ✓ All standards met (async/await, type hints, no print except for user prompts, proper logging)
- Project Structure: ✓ Correct location (core/ingestion/)
- Testing Strategy: ✓ POC script provided for validation
- All ACs Met: ✓ All 10 acceptance criteria satisfied

### Security Review

- ✓ Session state path from config (not hardcoded)
- ✓ No credentials in code
- ✓ Proper browser cleanup

### Performance Considerations

- ✓ Randomized delays prevent detection
- ✓ Proper timeout configuration
- ✓ Efficient screenshot capture

### Gate Status

Gate: **PASS** → docs/qa/gates/1.4-playwright-poc.yml
Quality Score: 95/100

### Recommended Status

✓ **Ready for Done** - Solid Playwright POC implementation with proper async patterns and error handling.
