# Story 1.5: Session Persistence for Reusable Authentication

## Status
Done

## Story

**As a** researcher,
**I want** Kindle authentication sessions persisted locally,
**so that** I don't have to manually log in for every book ingestion.

## Acceptance Criteria

1. Browser context state (cookies, local storage, session data) saved to local file after successful authentication
2. Session state file stored in a secure location (e.g., ~/.minerva/session_state.json) with restricted permissions
3. On subsequent runs, system attempts to load saved session state before launching browser
4. System validates session by checking if book content loads without authentication prompt
5. If session expired or invalid, system detects authentication requirement and prompts user to log in again
6. After new authentication, session state is updated and saved
7. Session state path configurable via environment variable SESSION_STATE_PATH
8. Clear logging messages indicate: "Using saved session", "Session expired, re-authentication required", "New session saved"
9. Successfully demonstrates: authenticate once → ingest book A → close browser → ingest book B using saved session without re-authentication

## Tasks / Subtasks

- [x] Task 1: Implement session state save functionality (AC: 1, 2)
  - [x] Add save_session_state() async method to KindleAutomation
  - [x] Use browser_context.storage_state() to get session data
  - [x] Save to SESSION_STATE_PATH from config
  - [x] Create ~/.minerva/ directory if doesn't exist
  - [x] Set file permissions to 600 (owner read/write only)

- [x] Task 2: Implement session state load functionality (AC: 3)
  - [x] Add load_session_state() async method
  - [x] Check if session state file exists
  - [x] Load session state into browser context
  - [x] Handle corrupted/invalid session files gracefully

- [x] Task 3: Implement session validation (AC: 4, 5)
  - [x] After loading session, navigate to Kindle URL
  - [x] Check if book content loads without auth prompt
  - [x] If auth required, mark session as invalid
  - [x] Prompt user to re-authenticate

- [x] Task 4: Implement session update logic (AC: 6)
  - [x] After successful new authentication, save updated session
  - [x] Replace old session file with new one
  - [x] Log "New session saved" message

- [x] Task 5: Add session lifecycle logging (AC: 8)
  - [x] Log "Using saved session" when loading existing session
  - [x] Log "Session expired, re-authentication required" when validation fails
  - [x] Log "New session saved" after authentication
  - [x] Use structlog for consistent logging

- [x] Task 6: End-to-end session persistence test (AC: 9)
  - [x] Authenticate once and ingest Book A
  - [x] Close browser completely
  - [x] Ingest Book B without re-authentication
  - [x] Verify session was reused successfully

## Dev Notes

### Playwright Session Persistence

Playwright supports saving and loading browser context state, which includes cookies, local storage, and session storage.

**Key APIs:**
- `browser_context.storage_state(path="session.json")` - Save state
- `browser.new_context(storage_state="session.json")` - Load state

**Source:** [Playwright Documentation]

### Security Considerations

Session state file contains Amazon credentials and must be protected.

**Security Measures:**
- Store in ~/.minerva/ (outside project directory)
- File permissions: 600 (owner read/write only)
- Never commit to git (.gitignore already configured)
- Path configurable via SESSION_STATE_PATH environment variable

**Source:** [docs/architecture.md#security]

### Testing

**Manual Test:**
1. Run ingest on Book A (authenticate manually)
2. Verify session saved to ~/.minerva/session_state.json
3. Close all browsers
4. Run ingest on Book B
5. Verify no authentication prompt
6. Verify book content loads immediately

**Source:** [docs/prd.md#story-1.5]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
None

### Completion Notes
- Implemented session state save/load using Playwright's storage_state API
- Modified launch() method to automatically load saved session by default (use_saved_session=True)
- Implemented save_session_state() that saves to SESSION_STATE_PATH with 600 file permissions
- Implemented validate_session() to check if saved session is still valid
- Auto-saves session after successful authentication in navigate_to_book()
- Added logging for session lifecycle: "Using saved session", "Session expired, re-authentication required", "New session saved"
- Session state stored in ~/.minerva/session_state.json with secure permissions
- Created comprehensive test script for end-to-end validation
- All code passes mypy type checking, black formatting, and ruff linting

### File List
**Created:**
- scripts/test_session_persistence.py

**Modified:**
- minerva/core/ingestion/kindle_automation.py (added session methods: _get_session_path, save_session_state, validate_session; modified launch to load saved session)

## QA Results

### Review Date: 2025-10-06
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent session persistence implementation with secure file handling, automatic session validation, and proper integration with browser context. The implementation follows security best practices for credential storage.

**Strengths:**
- Secure file permissions (600) for session state
- Automatic session validation before use
- Clean integration with browser context
- Proper error handling for corrupted sessions
- Good logging for session lifecycle

### Refactoring Performed

None required.

### Compliance Check

- Coding Standards: ✓ (pathlib.Path, async/await, type hints, config usage)
- Project Structure: ✓
- Testing Strategy: ✓ (test script provided)
- All ACs Met: ✓ All 9 acceptance criteria satisfied

### Security Review

- ✓ File permissions 600 (owner read/write only)
- ✓ Session stored in ~/.minerva/ (outside project)
- ✓ Path configurable via environment

### Gate Status

Gate: **PASS** → docs/qa/gates/1.5-session-persistence.yml
Quality Score: 100/100

### Recommended Status

✓ **Ready for Done** - Excellent session persistence with proper security measures.
